ALTER TABLE "product_variant_combinations" DISABLE ROW LEVEL SECURITY;--> statement-breakpoint
DROP VIEW "public"."products_view";--> statement-breakpoint
DROP TABLE "product_variant_combinations" CASCADE;--> statement-breakpoint
ALTER TABLE "products" ADD COLUMN "stock" integer DEFAULT 0 NOT NULL;--> statement-breakpoint
CREATE UNIQUE INDEX "products_code_idx" ON "products" USING btree ("code");--> statement-breakpoint
CREATE VIEW "public"."products_view" AS (select "products"."id", "products"."name", "categories"."id" as "category_id", "categories"."name" as "category_name", "vendors"."id" as "vendor_id", "vendors"."name" as "vendor_name", "products"."status", MIN("product_images"."url") as "image_url", "products"."price", "products"."stock", MIN("product_variants"."extra_price") as "min_price", MAX("product_variants"."extra_price") as "max_price", AVG("product_reviews"."rating") as "average_rating" from "products" inner join "categories" on "products"."category_id" = "categories"."id" inner join "vendors" on "vendors"."id" = "products"."vendor_id" left join "product_images" on "products"."id" = "product_images"."product_id" left join "product_variant_groups" on "products"."id" = "product_variant_groups"."product_id" left join "product_variants" on "product_variant_groups"."id" = "product_variants"."variant_group_id" left join "product_reviews" on "products"."id" = "product_reviews"."product_id" group by "products"."id", "products"."name", "products"."status", "products"."price", "products"."stock", "categories"."id", "categories"."name", "vendors"."id", "vendors"."name");
